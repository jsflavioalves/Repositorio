<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
function Gera(){
 var ARR = ['28542304349', '06640402335', '02626375373', '07178659327', '01022802313', '48274917553', '68147309520', '07156918486', '01569122440', '05367091490', '72700858115', '94367710106', '02091946427', '71613471149', '04620126462', '02534612433', '02446548246', '71058532200', '82142017134', '91767490453', '03297759445', '05147928332', '99347199591', '61356395368', '60335188370', '07748705321', '09469661419', '05816120352', '08909337400', '02447936389', '72610867468', '31573894320', '00371949335', '07123688414', '04841442359', '03015942441', '04635204324', '06625752371', '45997810291', '05437365390', '04554032361', '74505050378', '82297452349', '05169487681', '39834344368', '02033910393', '06405939413', '52525511387', '04048137476', '26573377320', '05216683364', '77769813549', '11104269414', '03624448382', '05861983429', '04902606321', '06114302311', '11168734606', '00320860329', '21802487840', '16971910702', '23502509387', '92635636320', '04697484606', '03352433399', '04201834425', '66071445353', '02916879382', '88623807553', '92782876520', '67261540382', '05026057314', '46827650359', '98861280382', '01010455303', '25753513832', '61001953991', '03033428460', '06045939379', '79930360387', '16143065756', '12763866646', '03536550401', '96807504349', '60456541373', '13603275764', '31201006848', '05748557347', '05169646313', '64281086315', '53355300306', '85769231300', '06178043384', '92605400387', '03132638331', '01963450302', '44561687300', '60402669371', '85966959315', '11216741786', '83886877353', '98662708315', '02626375373', '07178659327', '95126457268', '48274917553', '68147309520', '92933912104', '07582139488', '08489983402', '02361616106', '70019117477', '04620126462', '06790503455', '13572172349', '87039141191', '81438885253', '62751310206', '78292581200', '88216454104', '03566123412', '78890551291', '74240900204', '74745646291', '03511463424', '71613471149', '79750761200', '02091946427', '05992314471', '02091946427', '09490939471', '05931475532', '73322644200', '73322644200', '02446548245', '63838540204', '00195239202', '71058532200', '38058154253', '16981146215', '68795467220', '91112729715', '78552834200', '63231590230', '56015917253', '78552834200', '85601438234', '89638255234', '00102742510', '01055832190', '00902219588', '01860101178', '17087368249', '00605038883', '35727020204', '03793326390', '03470475482', '00117792250', '71459693272', '02224826567', '68409001268', '93918615200', '66977649291', '42877822249', '50878956204', '46331859268', '57712824215', '91706289472', '02212410514', '05816120352', '00527511552', '90471431591', '07256536470', '83216319272', '00023547561', '75985195287', '04413867416', '04524956360', '04524956360', '01880166275', '04981824440', '01560258250', '69928894272', '01245710265', '50787004200', '87114429304', '00127736543', '50878956204', '60786361204', '98154982404', '03955103412', '03955103412', '66807034253', '65781333215', '45997810291', '97690635172', '58081585320', '20524684391', '00841070300', '38458934353', '54934923349', '01681032309', '76903478353', '68197870306', '00677423357', '91977770304', '05677501328', '23185643372', '98768026315', '00677423357', '31410766349', '76571521334', '89970268368', '58945474315', '63499380382', '74056247315', '83633537368', '90306775387', '00157218503', '00754313352', '01628786302', '68346344286', '90351878149', '06941422394', '61567353215', '01482517302', '49763555191', '58198624672', '36855162304', '95072730344', '94761973234', '51048795268', '49056735268', '02622787316', '02622787316', '14303752304', '74817752300', '04554032361', '85843393100', '14303752304', '02622787316', '89663284315', '04877776460', '01034220489', '80305946315', '97557811472', '97557811472', '26573377320', '97557811372', '88391280349', '73327700320', '03459972475', '64620280410', '07104458301', '78888905472', '03517215414', '45392676200', '88583759391', '39454398504', '01019407344', '40927499587', '26573377320', '69981159387', '05739793670', '10387436642', '06322134698', '06061690673', '06061690673', '13920248627', '02503512429', '58723048204', '81527446387', '05699181466', '58723048204', '06085211325', '75234610349', '75234610349', '84199296204', '07516174661', '00358001358', '21802487840', '00336344325', '23592309387', '05042147640', '76709396304', '02474994475', '09653020676', '03339018600', '00785681299', '07853772637', '04697394445', '05713025489', '07517271482', '03389753494', '00014038642', '66071445353', '68773854204', '72426683287', '88623807553', '92782876520', '11642639605', '04787068393', '02100804502', '05026057314', '00265184223', '30100216315', '85982270300', '75334610349', '75234610349', '33940344842', '07129499508', '26187094115', '70784825300', '73768073300', '72820055249', '06200958220', '12673484612', '79930360387', '02134180455', '49495038391', '73768073300', '02134180455', '09880317440', '92563198534', '41014103304', '04475047463', '76777324453', '05024731425', '09439774444', '05024731425', '09439774444', '06966308420', '28166086204', '05813720340', '01921316489', '00667995200', '40224457500', '83353380272', '04817673478', '70902277415', '03288771403', '93678681468', '00394641566', '04630296409', '04630296409', '06986968400', '06684983317', '63048582215', '59896450900', '01820414256', '20951892304'];
 var index = -1;

//chama-se assim: next();
function next(){
    console.log('index;cpf;nome;cns;cbo;cnes;equipe;uf;coMun;noMun');
    next();
}
function next(){
    index++;
    if(ARR[index])
        get1(ARR[index]);
}
function get1(cpf){
    $.ajax({
        method: "GET",
        url: "http://cnes.datasus.gov.br/services/profissionais?cpf=" + cpf
    })
    .done(function( data ) {
        if(data == "" || data.length == 0) {
            var cpf = ARR[index];
            console.log(index + ';' + cpf);
            next();
        }
        else {
            if(data[0].cns) {
                var id = data[0].id;
                get11(id);
            }
            else {
                console.log('erro 01 parou em cpf: ' + cpf);
            }
        }
    })
    .fail(function() {
        var cpf = ARR[index];
        console.log(index + ';' + cpf);
        next();
    });
}
function get11(id){
    $.ajax({
        method: "GET",
        url: "http://cnes.datasus.gov.br/services/profissionais-equipes/" + id
    })
    .done(function( data ) {
        if(data == "") {
            alert("Não encontrado get11!");
        }
        else {
            if(data.vinculos.length > 0 && data.vinculos[0]) {
                var cpf = ARR[index];
                var nome = data.nome;
                var cns = data.cns;
                var cbo = data.vinculos[0].cbo;
                var cnes = data.vinculos[0].cnes;
                var equipe = data.vinculos[0].coEquipe;
                var uf = data.vinculos[0].estado;
                var coMun = data.vinculos[0].coMunicipio;
                var noMun = data.vinculos[0].noMunicipio;
                console.log(index + ';' + cpf + ';' + nome + ';' + cns + ';' + cbo + ';' + cnes + ';' + equipe + ';' + uf + ';' + coMun + ';' + noMun);
                next();
            }
            else{
                console.log('não tem vinculo');
            }
        }
    })
    .fail(function() {
        var cpf = ARR[index];
        //console.log(index + ';' + cpf);
        //next();
        get2(id);
    });
}
function get2(id){
    $.ajax({
        method: "GET",
        url: "http://cnes.datasus.gov.br/services/profissionais/" + id
    })
    .done(function( data ) {
        if(data == "") {
            alert("Não encontrado get2!");
        }
        else {
            if(data.vinculos.length > 0 && data.vinculos[0]) {
                var cpf = ARR[index];
                var nome = data.nome;
                var cns = data.cns;
                var cbo = data.vinculos[0].cbo;
                var cnes = data.vinculos[0].cnes;
                var equipe = '';
                var uf = data.vinculos[0].estado;
                var coMun = data.vinculos[0].coMun;
                var noMun = data.vinculos[0].noMun;
                console.log(index + ';' + cpf + ';' + nome + ';' + cns + ';' + cbo + ';' + cnes + ';' + equipe + ';' + uf + ';' + coMun + ';' + noMun);
                next();
            }
            else{
                console.log('não tem vinculo');
            }
        }
    })
    .fail(function() {
        var cpf = ARR[index];
        console.log(index + ';' + cpf);
        next();
    });
}
}
</script>
</head>
<body>

<div id="demo">
  <h2>Gera informações CNES,CBO</h2>
  <button type="button" onclick="Gera()">Gera Inf</button>
</div>

</body>
</html> 